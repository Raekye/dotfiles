
set exrc
set secure

set number
set ruler
set scrolloff=4

set hidden
set backspace=indent,eol,start
set autoread " update if changed externally and not modified locally
set nobackup " make backup before overwriting, and leave it around
set noswapfile " use swapfile for buffer

set encoding=utf-8
set ffs=unix,dos
set list
set listchars=tab:>\ ,eol:$ " tab before eol so trailing space doesn't get stripped
set listchars+=multispace:-,lead:-,trail:-
set listchars+=extends:>,precedes:<,conceal:!,nbsp:%
if v:version >= 900
	set listchars+=leadmultispace:\|---
else
endif
set conceallevel=0

set shiftwidth=4
set tabstop=4

set smartindent " less strict than cindent
set autoindent
set breakindent

set ignorecase
set smartcase
set incsearch " ctrl-g and ctrl-t to move to next and previous match

set showcmd
set laststatus=2 " always show status line for last window

set wildmenu " command line completion
if v:version >= 900
	set wildoptions=pum " display using popup menu
endif

set ssop-=options
set ssop-=curdir
set ssop+=sesdir

set cscopequickfix=s-,g-,c-
set cscopetag

filetype on
syntax enable

let g:mapleader = ','

" Documented under `:help filetype`
let g:markdown_recommended_style = 0 " disable expandtab
let g:python_recommended_style = 0 " disable expandtab

let g:NERDTreeShowLineNumbers = 1
let g:NERDTreeShowHidden = 1

let g:NERDCreateDefaultMappings = 0

let g:ctrlp_show_hidden = 1
let g:ctrlp_working_path_mode = 0 " set local working directory to pwd
let g:ctrlp_max_files = 0
if executable('ag')
	let g:ctrlp_user_command = 'ag -l --nocolor -g "" %s'
endif

"let g:airline#extensions#tabline#enabled = 1
let g:airline_symbols_ascii = 1

if executable('ag')
	let g:ackprg = 'ag --vimgrep'
else
	let g:ackprg = 'grep --recursive --line-number'
endif

" The bang (exclamation mark) modifier/suffix passed to `fzf` launches it in fullscreen.
command! -bang -nargs=* Rg call fzf#vim#grep('rg --column --line-number --no-heading --color always --smart-case --hidden -- ' . fzf#shellescape(<q-args>), fzf#vim#with_preview(), <bang>0)
command! -bang -nargs=* Grep call fzf#vim#grep('grep --recursive --extended-regexp --line-number -- ' . fzf#shellescape(<q-args>), fzf#vim#with_preview(), <bang>0)

set omnifunc=ale#completion#OmniFunc
let g:ale_completion_enabled = 1
let g:ale_linters = { 'c': ['clangd'], 'cpp': ['clangd'], 'rust': ['analyzer'], }
let g:ale_fixers = { '*': ['remove_trailing_lines', 'trim_whitespace'] }
let g:ale_fix_on_save = 1
"let g:ale_virtualtext_cursor = 0

let g:gundo_prefer_python3 = 1

let g:rustfmt_autosave = 1
"let g:rustfmt_fail_silently = 1

call plug#begin('~/.vim/plugged')

Plug 'altercation/vim-colors-solarized'

Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'

Plug 'preservim/nerdtree'
Plug 'preservim/nerdcommenter'
Plug 'preservim/tagbar'

Plug 'junegunn/fzf', { 'do': { -> fzf#install() } }
Plug 'junegunn/fzf.vim'
"Plug 'ctrlpvim/ctrlp.vim'
"Plug 'mileszs/ack.vim'

Plug 'tpope/vim-surround'
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-rails'
" Enhance 'ga' output (shows info about character under the cursor).
Plug 'tpope/vim-characterize'

Plug 'easymotion/vim-easymotion'

Plug 'dense-analysis/ale'

" https://github.com/junegunn/vim-plug/issues/1005
Plug 'airblade/vim-gitgutter', { 'branch': 'main' }

" The `rust.vim`/`rustfmt.vim` distributed with vim on Fedora 38 is out of date and calls rustfmt incorrectly.
Plug 'rust-lang/rust.vim'

" Not really used...
Plug 'sjl/gundo.vim'

call plug#end()

let g:solarized_termcolors = 256
let g:solarized_visibility = "low"
set background=light
if isdirectory($HOME . '/.vim/plugged/vim-colors-solarized')
	colorscheme solarized
endif

" non-recursive mapmode-nvo
no Q <Nop>
no <C-n> :NERDTreeToggle<CR>
no <C-p> :Files<CR>
no <C-l> :Buffers<CR>
no <C-g> :TagbarToggle<CR>
no <C-h> <C-^>
no <C-k> <Plug>(ale_previous_wrap)
no <C-j> <Plug>(ale_next_wrap)
no <C-c> <Plug>NERDCommenterToggle
"no <Esc> :ccl<CR>:lcl<CR>

" non-recursive mapmode-n
"nn <leader>l :ls<CR>:buffer<space>
if executable('rg')
	nn <leader>g :Rg<space>
else
	nn <leader>g :Grep<space>
endif

nn <leader>w <Plug>(ale_find_references)
nn <leader>e <Plug>(ale_go_to_definition)
nn <leader>r :ALESymbolSearch <C-R>=expand("<cword>")<CR><CR>

"nn <leader>w :Gtags -s <C-R>=expand("<cword>")<CR><CR>
"nn <leader>e :Gtags <C-R>=expand("<cword>")<CR><CR>
"nn <leader>r :Gtags -r <C-R>=expand("<cword>")<CR><CR>
nn <leader>s :Gtags -s<space>
nn <leader>d :Gtags<space>
nn <leader>f :Gtags -r<space>

nn <leader>u :GundoToggle<CR>

" https://github.com/mhinz/vim-galore#saner-behavior-of-n-and-n
" Make 'n' and 'N' search direction agnostic of '/' and '?'.
nn <expr> n 'Nn'[v:searchforward]
nn <expr> N 'nN'[v:searchforward]

" non-recursive mapmode-c
" https://github.com/mhinz/vim-galore#saner-command-line-history
" Make '<C-n>' and '<C-p>' autocomplete based on matching prefix.
cno <expr> <c-n> wildmenumode() ? "\<C-n>" : "\<down>"
cno <expr> <c-p> wildmenumode() ? "\<C-p>" : "\<up>"
